{% extends "admin/base_site.html" %}
{% load static %}

{% block extrastyle %}
<style>
    body {
        background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
        min-height: 100vh;
    }
    
    .confirm-container {
        max-width: 1200px;
        margin: 40px auto;
        background: white;
        border-radius: 12px;
        box-shadow: 0 10px 40px rgba(0,0,0,0.1);
        padding: 40px;
    }
    
    .confirm-title {
        font-size: 28px;
        font-weight: 600;
        color: #333;
        margin-bottom: 10px;
        text-align: center;
    }
    
    .confirm-subtitle {
        font-size: 14px;
        color: #666;
        text-align: center;
        margin-bottom: 30px;
    }
    
    .section {
        margin-bottom: 30px;
    }
    
    .section-title {
        font-size: 20px;
        font-weight: 600;
        color: #444;
        margin-bottom: 15px;
        padding-bottom: 10px;
        border-bottom: 3px solid #4facfe;
    }
    
    .conflict-warning {
        background: linear-gradient(135deg, #fff3cd 0%, #fff0b3 100%);
        border-left: 4px solid #ffc107;
        padding: 20px;
        border-radius: 8px;
        margin-bottom: 20px;
    }
    
    .conflict-warning-title {
        font-size: 16px;
        font-weight: 600;
        color: #856404;
        margin-bottom: 10px;
    }
    
    .validation-warning {
        background: linear-gradient(135deg, #f8d7da 0%, #f5c6cb 100%);
        border-left: 4px solid #dc3545;
        padding: 20px;
        border-radius: 8px;
        margin-bottom: 20px;
    }
    
    .validation-warning-title {
        font-size: 16px;
        font-weight: 600;
        color: #721c24;
        margin-bottom: 10px;
    }
    
    .table-wrapper {
        overflow-x: auto;
        margin-top: 15px;
    }
    
    table {
        width: 100%;
        border-collapse: collapse;
        font-size: 14px;
    }
    
    th {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 12px;
        text-align: left;
        font-weight: 600;
    }
    
    td {
        padding: 12px;
        border-bottom: 1px solid #e0e0e0;
    }
    
    tr:hover {
        background: #f8f9fa;
    }
    
    .conflict-row {
        background: #fff3cd;
    }
    
    .exceed-row {
        background: #f8d7da;
    }
    
    .badge {
        display: inline-block;
        padding: 4px 8px;
        border-radius: 4px;
        font-size: 12px;
        font-weight: 600;
    }
    
    .badge-conflict {
        background: #ffc107;
        color: #856404;
    }
    
    .badge-exceed {
        background: #dc3545;
        color: white;
    }
    
    .radio-group {
        background: #e8f5e9;
        padding: 20px;
        border-radius: 8px;
        margin-bottom: 25px;
    }
    
    .radio-group-title {
        font-size: 16px;
        font-weight: 600;
        color: #2e7d32;
        margin-bottom: 15px;
    }
    
    .radio-option {
        display: flex;
        align-items: center;
        margin-bottom: 12px;
        cursor: pointer;
    }
    
    .radio-option input[type="radio"] {
        margin-right: 10px;
        width: 18px;
        height: 18px;
        cursor: pointer;
    }
    
    .radio-option label {
        font-size: 15px;
        color: #333;
        cursor: pointer;
        flex: 1;
    }
    
    .radio-option-desc {
        font-size: 13px;
        color: #666;
        margin-left: 28px;
        margin-top: -8px;
        margin-bottom: 8px;
    }
    
    .button-group {
        display: flex;
        gap: 15px;
        margin-top: 30px;
    }
    
    .btn {
        flex: 1;
        padding: 15px;
        border: none;
        border-radius: 8px;
        font-size: 16px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
    }
    
    .btn-confirm {
        background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
        color: white;
    }
    
    .btn-confirm:hover {
        transform: translateY(-2px);
        box-shadow: 0 5px 20px rgba(79, 172, 254, 0.4);
    }
    
    .btn-cancel {
        background: #e0e0e0;
        color: #666;
    }
    
    .btn-cancel:hover {
        background: #d0d0d0;
    }
    
    /* è¿›åº¦æ¡æ ·å¼ */
    .progress-overlay {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.7);
        z-index: 9999;
        align-items: center;
        justify-content: center;
    }
    
    .progress-overlay.active {
        display: flex;
    }
    
    .progress-container {
        background: white;
        border-radius: 12px;
        padding: 40px;
        max-width: 500px;
        width: 90%;
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
    }
    
    .progress-title {
        font-size: 20px;
        font-weight: 600;
        color: #333;
        text-align: center;
        margin-bottom: 20px;
    }
    
    .progress-info {
        text-align: center;
        color: #666;
        font-size: 14px;
        margin-bottom: 20px;
    }
    
    .progress-bar-wrapper {
        width: 100%;
        height: 30px;
        background: #f0f0f0;
        border-radius: 15px;
        overflow: hidden;
        margin-bottom: 15px;
        position: relative;
    }
    
    .progress-bar {
        height: 100%;
        background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
        border-radius: 15px;
        transition: width 0.3s ease;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-weight: 600;
        font-size: 14px;
    }
    
    .progress-detail {
        text-align: center;
        color: #888;
        font-size: 13px;
    }
</style>
{% endblock %}

{% block content %}
<div class="confirm-container">
    <h1 class="confirm-title">âš ï¸ åšå£«åé¢å¯¼å…¥ç¡®è®¤</h1>
    <p class="confirm-subtitle">è¯·ä»”ç»†æ£€æŸ¥ä»¥ä¸‹ä¿¡æ¯ï¼Œç¡®è®¤æ— è¯¯åé€‰æ‹©å¯¼å…¥æ–¹å¼</p>
    
    <form method="post" id="confirmForm">
        {% csrf_token %}
        <input type="hidden" name="confirm_import" value="1">
        <input type="hidden" name="import_data" value="{{ import_data_json }}">
        
        {% if conflicts %}
        <div class="section">
            <div class="conflict-warning">
                <div class="conflict-warning-title">âš ï¸ æ£€æµ‹åˆ° {{ conflicts|length }} ä¸ªåé¢å†²çª</div>
                <p style="margin: 10px 0 0 0; color: #856404; font-size: 14px;">
                    ä»¥ä¸‹å¯¼å¸ˆåœ¨å¯¹åº”å­¦ç§‘å·²æœ‰åšå£«æ‹›ç”Ÿåé¢è®°å½•ï¼Œè¯·é€‰æ‹©å¤„ç†æ–¹å¼ï¼š
                </p>
            </div>
            
            <div class="table-wrapper">
                <table>
                    <thead>
                        <tr>
                            <th>å¯¼å¸ˆå§“å</th>
                            <th>å·¥å·</th>
                            <th>å­¦ç§‘åç§°</th>
                            <th>å­¦ç§‘ä»£ç </th>
                            <th>ç°æœ‰åé¢</th>
                            <th>æœ¬æ¬¡å¯¼å…¥</th>
                            <th>çŠ¶æ€</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for item in conflicts %}
                        <tr class="conflict-row">
                            <td>{{ item.professor_name }}</td>
                            <td>{{ item.teacher_identity_id }}</td>
                            <td>{{ item.subject_name }}</td>
                            <td>{{ item.subject_code }}</td>
                            <td><strong>{{ item.existing_quota }}</strong></td>
                            <td><strong>{{ item.quota }}</strong></td>
                            <td><span class="badge badge-conflict">å†²çª</span></td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            
            <div class="radio-group">
                <div class="radio-group-title">ğŸ”§ å†²çªå¤„ç†æ–¹å¼</div>
                <div class="radio-option">
                    <input type="radio" name="conflict_action" id="action_replace" value="replace" checked>
                    <label for="action_replace"><strong>è¦†ç›–æ¨¡å¼</strong> - ä½¿ç”¨æœ¬æ¬¡å¯¼å…¥çš„åé¢æ›¿æ¢åŸæœ‰åé¢</label>
                </div>
                <div class="radio-option-desc">
                    ä¾‹å¦‚ï¼šåŸæœ‰åé¢5äººï¼Œæœ¬æ¬¡å¯¼å…¥3äºº â†’ æœ€ç»ˆåé¢ä¸º3äºº
                </div>
                
                <div class="radio-option">
                    <input type="radio" name="conflict_action" id="action_add" value="add">
                    <label for="action_add"><strong>å¢åŠ æ¨¡å¼</strong> - åœ¨åŸæœ‰åé¢åŸºç¡€ä¸Šå¢åŠ æœ¬æ¬¡å¯¼å…¥çš„åé¢</label>
                </div>
                <div class="radio-option-desc">
                    ä¾‹å¦‚ï¼šåŸæœ‰åé¢5äººï¼Œæœ¬æ¬¡å¯¼å…¥3äºº â†’ æœ€ç»ˆåé¢ä¸º8äºº
                </div>
            </div>
        </div>
        {% endif %}
        
        {% if validation_result.warnings %}
        <div class="section">
            <div class="validation-warning">
                <div class="validation-warning-title">âŒ åé¢è¶…é¢è­¦å‘Š</div>
                <p style="margin: 10px 0 0 0; color: #721c24; font-size: 14px;">
                    ä»¥ä¸‹ä¸“ä¸šçš„å¯¼å¸ˆåé¢æ€»å’Œè¶…è¿‡ä¸“ä¸šæ€»æ‹›ç”Ÿåé¢ï¼Œè¯·è°ƒæ•´åé‡æ–°å¯¼å…¥ï¼š
                </p>
            </div>
            
            <div class="table-wrapper">
                <table>
                    <thead>
                        <tr>
                            <th>å­¦ç§‘åç§°</th>
                            <th>å­¦ç§‘ä»£ç </th>
                            <th>å¯¼å¸ˆåé¢æ€»å’Œ</th>
                            <th>ä¸“ä¸šæ€»æ‹›ç”Ÿåé¢</th>
                            <th>è¶…å‡º</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for warning in validation_result.warnings %}
                        <tr class="exceed-row">
                            <td>{{ warning.subject_name }}</td>
                            <td>{{ warning.subject_code }}</td>
                            <td><strong>{{ warning.import_total }}</strong></td>
                            <td>{{ warning.subject_total }}</td>
                            <td><span class="badge badge-exceed">+{{ warning.exceed }}</span></td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
        {% endif %}
        
        <div class="section">
            <div class="section-title">ğŸ“Š å¯¼å…¥æ•°æ®ç»Ÿè®¡ï¼ˆå…± {{ import_data|length }} æ¡ï¼‰</div>
            
            <div class="table-wrapper">
                <table>
                    <thead>
                        <tr>
                            <th>å¯¼å¸ˆå§“å</th>
                            <th>å·¥å·</th>
                            <th>å­¦ç§‘åç§°</th>
                            <th>å­¦ç§‘ä»£ç </th>
                            <th>æœ¬æ¬¡åé¢</th>
                            <th>ç°æœ‰åé¢</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for item in import_data %}
                        <tr {% if item.has_conflict %}class="conflict-row"{% endif %}>
                            <td>{{ item.professor_name }}</td>
                            <td>{{ item.teacher_identity_id }}</td>
                            <td>{{ item.subject_name }}</td>
                            <td>{{ item.subject_code }}</td>
                            <td><strong>{{ item.quota }}</strong></td>
                            <td>{{ item.existing_quota }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
        
        <div class="button-group">
            <a href="{% url 'admin:import_doctor_quota' %}" class="btn btn-cancel">
                â† å–æ¶ˆå¯¼å…¥
            </a>
            <button type="submit" class="btn btn-confirm" id="confirmBtn">
                âœ”ï¸ ç¡®è®¤å¯¼å…¥
            </button>
        </div>
    </form>
</div>

<!-- è¿›åº¦æ¡é®ç½©å±‚ -->
<div id="progressOverlay" class="progress-overlay">
    <div class="progress-container">
        <div class="progress-title">ğŸ’¾ æ­£åœ¨å†™å…¥æ•°æ®...</div>
        <div class="progress-info" id="progressInfo">æ­£åœ¨ä¿å­˜å¯¼å¸ˆåé¢...</div>
        <div class="progress-bar-wrapper">
            <div class="progress-bar" id="progressBar" style="width: 0%;">0%</div>
        </div>
        <div class="progress-detail" id="progressDetail">æ­£åœ¨æ›´æ–°æ•°æ®åº“...</div>
    </div>
</div>

<script>
document.getElementById('confirmForm').addEventListener('submit', function(e) {
    const overlay = document.getElementById('progressOverlay');
    const progressBar = document.getElementById('progressBar');
    const progressInfo = document.getElementById('progressInfo');
    const progressDetail = document.getElementById('progressDetail');
    const confirmBtn = document.getElementById('confirmBtn');
    
    // ç¦ç”¨æŒ‰é’®
    confirmBtn.disabled = true;
    confirmBtn.textContent = 'æ­£åœ¨å¤„ç†...';
    
    // æ˜¾ç¤ºè¿›åº¦æ¡
    overlay.classList.add('active');
    
    // è·å–å¯¼å…¥æ•°æ®çš„æ•°é‡
    const importDataCount = {{ import_data|length }};
    
    // æ¨¡æ‹Ÿå†™å…¥è¿›åº¦
    let progress = 0;
    progressInfo.textContent = `æ­£åœ¨ä¿å­˜ ${importDataCount} æ¡åé¢è®°å½•...`;
    
    const progressInterval = setInterval(function() {
        progress += Math.random() * 8;
        if (progress > 90) {
            progress = 90; // åœåœ¨90%ï¼Œç­‰å¾…æœåŠ¡å™¨å®Œæˆ
            clearInterval(progressInterval);
        }
        
        progressBar.style.width = progress + '%';
        progressBar.textContent = Math.floor(progress) + '%';
        
        if (progress < 30) {
            progressDetail.textContent = 'æ­£åœ¨æ›´æ–°å¯¼å¸ˆåé¢æ•°æ®...';
        } else if (progress < 60) {
            progressDetail.textContent = 'æ­£åœ¨æ›´æ–°ä¸“ä¸šæ€»æ‹›ç”Ÿåé¢...';
        } else if (progress < 90) {
            progressDetail.textContent = 'æ­£åœ¨åŒæ­¥å­¦ç”Ÿå€™è¡¥çŠ¶æ€...';
        }
    }, 300);
    
    // è¡¨å•æ­£å¸¸æäº¤
});
</script>
{% endblock %}
