<!-- templates/admin/student_change_list.html -->
{% extends "admin/change_list.html" %}
{% block content_title %}
    <h1>学生管理</h1>
    <div style="margin-bottom: 20px;">
        <a href="{% url 'admin:import_students' %}" class="addlink">
            一键导入学生账号
        </a>
    </div>
{% endblock %}
{% block object-tools %}
    {{ block.super }}
{% endblock %}

{% block result_list %}
    {{ block.super }}
    <script>
        console.log('Student change list JavaScript loaded');
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOMContentLoaded event fired');

            // 获取 CSRF 令牌
            function getCookie(name) {
                let cookieValue = null;
                if (document.cookie && document.cookie !== '') {
                    const cookies = document.cookie.split(';');
                    for (let i = 0; i < cookies.length; i++) {
                        const cookie = cookies[i].trim();
                        if (cookie.substring(0, name.length + 1) === (name + '=')) {
                            cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                            break;
                        }
                    }
                }
                console.log('CSRF token:', cookieValue);
                return cookieValue;
            }

            const csrftoken = getCookie('csrftoken');

            // 使用事件委托处理动态加载的按钮
            document.body.addEventListener('click', function(e) {
                if (e.target.classList.contains('download-btn')) {
                    e.preventDefault();
                    const button = e.target;
                    const fileId = button.getAttribute('data-file-id');
                    console.log('Download button clicked, fileId:', fileId);

                    const originalText = button.textContent;
                    button.textContent = '加载中...';
                    button.style.pointerEvents = 'none';

                    fetch('/admin/professor_student_manage/download-file/', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': csrftoken
                        },
                        body: JSON.stringify({ file_id: fileId })
                    })
                    .then(response => {
                        console.log('Fetch response status:', response.status);
                        return response.json();
                    })
                    .then(data => {
                        button.textContent = originalText;
                        button.style.pointerEvents = 'auto';
                        console.log('Fetch response data:', data);
                        if (data.download_url) {
                            const link = document.createElement('a');
                            link.href = data.download_url;
                            link.download = '';
                            document.body.appendChild(link);
                            link.click();
                            document.body.removeChild(link);
                            console.log('Download triggered for URL:', data.download_url);
                        } else {
                            alert(data.message || '获取下载地址失败');
                            console.log('Error message:', data.message);
                        }
                    })
                    .catch(error => {
                        button.textContent = originalText;
                        button.style.pointerEvents = 'auto';
                        alert('下载失败: ' + error.message);
                        console.log('Fetch error:', error);
                    });
                }
            });

            // 调试：检查按钮是否存在
            const buttons = document.querySelectorAll('.download-btn');
            console.log('Found download buttons:', buttons.length, buttons);
        });
    </script>
{% endblock %}