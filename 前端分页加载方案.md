# 前端分页加载实现方案

## 修改 showProfessor.js

```javascript
// pages/showProfessor/showProfessor.js
import Dialog from '@vant/weapp/dialog/dialog';
const config = require('../../utils/config.js');
Page({
  /**
   * 页面的初始数据
   */
  data: {
    dialogShow: false,
    usertype: '',
    isTriggered: false,
    refreshText: '下拉刷新',
    activeKey: 0,
    active: 0,
    departmentList: '',
    professorList: '',
    selectedTeacherId:'',//当前查看的老师id
    professorId: [],
    show: false,
    show1: false,//展示弹框
    show2:false,
    selectedValue: [],
    isPopupOpen: true,
    checked:true,
    open_time: '',
    close_time: '',
    // 新增分页相关字段
    currentPage: 1,
    pageSize: 10,
    hasNextPage: false,
    isLoadingMore: false,
    selectedDepartmentId: null, // 当前选中的方向ID
    // 新增搜索相关字段
    searchKeyword: '',
    isSearchMode: false, // 是否在搜索模式
    searchResultCount: 0, // 搜索结果数量
  },

  // ... getMessage 等其他方法保持不变 ...

  // 新增：搜索导师
  onSearchChange(e) {
    this.setData({
      searchKeyword: e.detail
    });
  },

  // 新增：执行搜索
  onSearch() {
    const keyword = this.data.searchKeyword.trim();
    
    if (!keyword) {
      wx.showToast({
        title: '请输入搜索关键词',
        icon: 'none'
      });
      return;
    }

    // 进入搜索模式
    this.setData({
      isSearchMode: true,
      currentPage: 1,
      professorList: [],
      selectedDepartmentId: null // 搜索时不限定方向
    }, () => {
      this.loadProfessors(false);
    });
  },

  // 新增：取消搜索
  onSearchCancel() {
    this.setData({
      searchKeyword: '',
      isSearchMode: false,
      currentPage: 1,
      professorList: []
    }, () => {
      // 恢复到第一个方向
      const firstDepartmentId = this.data.departmentList && this.data.departmentList.length > 0 
        ? this.data.departmentList[0].id 
        : null;
      this.setData({
        selectedDepartmentId: firstDepartmentId,
        active: 0
      }, () => {
        this.loadProfessors(false);
      });
    });
  },

  // 新增：清空搜索
  onSearchClear() {
    this.setData({
      searchKeyword: ''
    });
  },

  // 新增：监听禁用标签的点击事件
  onClickDisabled(event) {
    wx.showToast({
      title: '搜索模式下无法切换方向，请先退出搜索',
      icon: 'none',
      duration: 2000
    });
  },

  // 修改 onChange 方法，在切换方向时重新加载数据
  onChange(event) {
    const departmentIndex = event.detail.name;
    const department = this.data.departmentList[departmentIndex];
    
    // 添加防御性检查
    if (!department || !department.id) {
      console.error('无效的方向数据', departmentIndex, department);
      return;
    }
    
    wx.showToast({
      title: `正在查看 ${event.detail.title}`,
      icon: 'none',
    });

    // 切换方向时重置数据并加载新方向的导师
    this.setData({
      active: departmentIndex,
      selectedDepartmentId: department.id,
      currentPage: 1,
      professorList: []
    }, () => {
      console.log('切换到方向:', department.department_name, 'ID:', department.id);
      this.loadProfessors();
    });
  },

  // 修改 onLoad，初始加载时只加载第一页数据
  onLoad(options) {
    const usertype = wx.getStorageSync('usertype');
    this.setData({
      usertype: usertype,
    });
    this.getSelectTime();

    var that = this;
    
    // 方案1：先加载所有方向，然后加载第一个方向的导师（推荐）
    wx.request({
      url: `${config.BASE_URL}/Professor_Student_Manage/professors_and_departments/`,
      method: "GET",
      data: {
        page: 1,
        page_size: 999 // 加载所有方向
      },
      success: function(res) {
        const departments = res.data['departments'];
        const firstDepartmentId = departments && departments.length > 0 ? departments[0].id : null;
        
        that.setData({
          departmentList: departments,
          selectedDepartmentId: firstDepartmentId
        });
        
        // 加载第一个方向的导师
        if (firstDepartmentId) {
          that.loadProfessors(false);
        }
      },
      fail: function(err) {
        console.error('获取方向信息失败：', err);
      }
    });
    
    /* 方案2：一次性加载所有数据（如果导师不多可以用这个）
    wx.request({
      url: `${config.BASE_URL}/Professor_Student_Manage/professors_and_departments/`,
      method: "GET",
      data: {
        page: 1,
        page_size: that.data.pageSize
      },
      success: function(res) {
        const departments = res.data['departments'];
        const firstDepartmentId = departments && departments.length > 0 ? departments[0].id : null;
        
        that.setData({
          departmentList: departments,
          professorList: res.data['professors'],
          hasNextPage: res.data['has_next'],
          currentPage: res.data['current_page'],
          selectedDepartmentId: firstDepartmentId
        });
      },
      fail: function(err) {
        console.error('获取导师信息失败：', err);
      }
    });
    */
  },

  // 新增：加载导师列表的方法
  loadProfessors(isLoadMore = false) {
    const that = this;
    
    if (this.data.isLoadingMore) {
      return; // 避免重复加载
    }

    this.setData({
      isLoadingMore: true
    });

    const params = {
      page: this.data.currentPage,
      page_size: this.data.pageSize
    };

    // 如果在搜索模式，添加搜索关键词
    if (this.data.isSearchMode && this.data.searchKeyword) {
      params.search = this.data.searchKeyword;
    } else {
      // 如果不在搜索模式，确保使用当前选中的方向ID
      // 优先使用 selectedDepartmentId，如果为空则从当前 active 的 tab 获取
      const departmentId = this.data.selectedDepartmentId || 
        (this.data.departmentList && this.data.departmentList.length > 0 && this.data.active >= 0
          ? this.data.departmentList[this.data.active].id 
          : null);
      
      if (departmentId) {
        params.department_id = departmentId;
        // 同步更新 selectedDepartmentId，确保状态一致
        if (!this.data.selectedDepartmentId) {
          this.setData({
            selectedDepartmentId: departmentId
          });
        }
      } else {
        console.error('无法获取当前方向ID，active:', this.data.active, 'departmentList:', this.data.departmentList);
      }
    }

    wx.request({
      url: `${config.BASE_URL}/Professor_Student_Manage/professors_and_departments/`,
      method: "GET",
      data: params,
      success: function(res) {
        const newProfessors = res.data['professors'];
        const updatedList = isLoadMore 
          ? that.data.professorList.concat(newProfessors)
          : newProfessors;

        that.setData({
          professorList: updatedList,
          hasNextPage: res.data['has_next'],
          currentPage: res.data['current_page'],
          isLoadingMore: false,
          searchResultCount: res.data['total_count']
        });

        // 如果是搜索模式且有结果，自动切换到对应的tab
        if (that.data.isSearchMode && newProfessors.length > 0 && !isLoadMore) {
          const firstProfessor = newProfessors[0];
          const departmentIndex = that.data.departmentList.findIndex(
            dept => dept.id === firstProfessor.department
          );
          if (departmentIndex !== -1) {
            that.setData({
              active: departmentIndex
            });
          }
        }

        // 如果是首次加载，也加载方向列表
        if (!isLoadMore && res.data['departments']) {
          that.setData({
            departmentList: res.data['departments']
          });
        }

        // 搜索结果提示
        if (that.data.isSearchMode && !isLoadMore) {
          if (newProfessors.length === 0) {
            wx.showToast({
              title: '未找到匹配的导师',
              icon: 'none'
            });
          } else {
            wx.showToast({
              title: `找到 ${res.data['total_count']} 位导师`,
              icon: 'success'
            });
          }
        }
      },
      fail: function(err) {
        console.error('获取导师信息失败：', err);
        that.setData({
          isLoadingMore: false
        });
        wx.showToast({
          title: '加载失败，请重试',
          icon: 'none'
        });
      }
    });
  },

  // 新增：上拉加载更多
  loadMoreProfessors() {
    if (!this.data.hasNextPage || this.data.isLoadingMore) {
      return;
    }

    // 添加调试日志，检查状态
    console.log('触发加载更多，当前页:', this.data.currentPage, 
                '方向ID:', this.data.selectedDepartmentId, 
                'active:', this.data.active);

    this.setData({
      currentPage: this.data.currentPage + 1
    }, () => {
      this.loadProfessors(true);
    });
  },

  // 修改下拉刷新方法
  onPullDownRefresh() {
    this.setData({
      isTriggered: true,
      refreshText: "刷新导师信息中...",
      currentPage: 1
    });
    
    // 如果在搜索模式，重新搜索；否则刷新当前方向
    this.loadProfessors(false);
    
    setTimeout(() => {
      this.setData({
        isTriggered: false,
        refreshText: "下拉刷新"
      });
    }, 1000);
  },

  // ... 其他方法保持不变 ...

  /**
   * 页面上拉触底事件的处理函数
   */
  onReachBottom() {
    this.loadMoreProfessors();
  },
});
```

## 修改 showProfessor.wxml

在滚动容器中添加固定搜索框和触底加载提示：

```xml
<!--pages/showProfessor/showProfessor.wxml-->
<page-meta page-style="{{ (show || show1) ? 'overflow: hidden;' : '' }}" />
<view class="mask" wx:if="{{isPopupOpen}}"></view>
<view class="con">
  <!-- 固定搜索框 -->
  <view class="search-container">
    <van-search
      value="{{ searchKeyword }}"
      placeholder="搜索导师姓名、研究方向..."
      show-action="{{ isSearchMode }}"
      bind:change="onSearchChange"
      bind:search="onSearch"
      bind:cancel="onSearchCancel"
      bind:clear="onSearchClear"
    />
  </view>

  <van-notice-bar
      scrollable
      text="互选开放时间: {{ open_time }}，互选关闭时间: {{ close_time }}"
    />
  
  <!-- 搜索结果提示 -->
  <view class="search-tip" wx:if="{{isSearchMode}}">
    <text>搜索"{{searchKeyword}}"，找到 {{searchResultCount}} 位导师</text>
    <van-icon name="cross" class="close-search" bind:tap="onSearchCancel" />
  </view>

  <view class="scroll">
    <view wx:if="{{isTriggered}}" class="refresh-text-container">
      <!-- 下拉刷新的视图内容 -->
      <text class="refresh-text">{{refreshText}}</text>
    </view>
    <scroll-view 
      class="center" 
      scroll-y="true" 
      refresher-enabled="{{!disablePullDownRefresh}}"
      bindrefresherrefresh="onPullDownRefresh"
      refresher-triggered="{{isTriggered}}"
      bindscrolltolower="loadMoreProfessors"
      lower-threshold="100"
    >
      <van-tabs
        swipeable="{{ !isSearchMode }}"
        animated 
        sticky 
        ellipsis="{{false}}"
        active="{{ active }}" 
        bind:change="onChange"
        bind:disabled="onClickDisabled"
      >
        <block wx:for="{{departmentList}}" wx:key="id" wx:for-item="ditem">
          <van-tab title="{{ditem.department_name}}" disabled="{{isSearchMode}}">
            <view wx:for="{{professorList}}" wx:key="id" wx:for-item="pitem">
              <!-- 搜索模式：显示所有匹配的导师；普通模式：只显示当前方向的导师 -->
              <block wx:if="{{isSearchMode || ditem.id === pitem.department}}">
                <!-- 导师卡片内容保持不变 -->
                <view class="van-card-container">
                  <van-card>
                    <view slot="thumb" class="professor-photo-container">
                        <image src="{{ pitem.avatar ? pitem.avatar : 'https://faculty.cau.edu.cn/_res/articleType/teacher_CN.jpg' }}"  mode="aspectFill" class="professor-photo"></image>
                    </view>
                    <view slot="desc">
                      <view class="name-container">
                        <view class="name">{{ pitem.name }}</view>
                      </view>
                      <view class="research-areas">研究方向：{{ pitem.research_areas }}</view>
                      <view class="enrollment-areas">硕士招生专业：</view>
                      <view class="choose">
                        <van-grid column-num="2">
                          <block wx:if="{{ pitem.master_subjects && pitem.master_subjects.length > 0 }}">
                            <van-grid-item use-slot wx:for="{{ pitem.master_subjects }}" wx:for-item="citem">
                              <van-checkbox value="{{ checked }}" icon-size="10px">{{citem}}</van-checkbox>
                            </van-grid-item>
                          </block>
                          <block wx:else>
                            <view class="no-data">暂无</view>
                          </block>
                        </van-grid>
                      </view>
                      <view class="enrollment-areas">博士招生专业：</view>
                      <view class="choose">
                        <van-grid column-num="2">
                          <block wx:if="{{ pitem.doctor_subjects && pitem.doctor_subjects.length > 0 }}">
                            <van-grid-item use-slot wx:for="{{ pitem.doctor_subjects }}" wx:for-item="citem">
                              <van-checkbox value="{{ checked }}" icon-size="10px">{{citem}}</van-checkbox>
                            </van-grid-item>
                          </block>
                          <block wx:else>
                            <view class="no-data">暂无</view>
                          </block>
                        </van-grid>
                      </view>
                      <view class="quotaremaing">剩余名额：</view>
                      <view class="quota-container">
                        <view class="master-container">
                          <view class="academic_quota">学硕剩余名额：{{ pitem.academic_quota }}</view>
                          <view class="professional_quota">博士剩余名额：{{ pitem.doctor_quota }}</view>
                        </view>
                        <view class="professional-container">
                          <view class="doctor_quota">北京专硕剩余名额：{{ pitem.professional_quota }}</view>
                          <view class="doctor_quota">烟台专硕剩余名额：{{ pitem.professional_yt_quota }}</view>
                        </view>
                      </view>
                      <view class="research-areas">联系方式：{{ pitem.contact_details ? pitem.contact_details : "未设置" }}</view>
                    </view>
                    <view slot="footer">
                      <van-button  round size="small" bind:click="showPopup" data-pid="{{pitem.id}}">查看简介</van-button>
                      <block wx:if="{{pitem.proposed_quota_approved}}">
                        <van-button round size="small" bindtap="showAlertDialog"
                        data-pid="{{pitem.id}}" data-pname="{{ pitem.name }}"
                        wx:if="{{ usertype === 'student' }}"
                        >选择Ta</van-button>
                      </block>
                      <block wx:else>
                        <van-button round size="small" disabled
                        >等待开放</van-button>
                      </block>
                    </view>
                  </van-card>
                </view>
              </block>
            </view>
            
            <!-- 加载提示 -->
            <view class="loading-container" wx:if="{{isLoadingMore}}">
              <van-loading type="spinner" size="24px">加载中...</van-loading>
            </view>
            
            <!-- 没有更多数据提示 -->
            <view class="no-more" wx:if="{{!hasNextPage && professorList.length > 0}}">
              <text>没有更多导师了</text>
            </view>
            
            <!-- 搜索无结果提示 -->
            <view class="no-result" wx:if="{{isSearchMode && professorList.length === 0 && !isLoadingMore}}">
              <van-empty description="未找到匹配的导师" />
            </view>
          </van-tab>
        </block>
      </van-tabs>
    </scroll-view>
  </view>
  
  <!-- 弹框等其他内容保持不变 -->
  <van-popup 
    show="{{ show }}" 
    bind:close="onClose" 
    position="bottom" 
    round
    custom-style="height: 65%" 
    closeable 
    close-icon-position="top-left"
    safe-area-tab-bar="{{true}}"
  >
    <!-- ... 保持原有内容不变 ... -->
  </van-popup>
  
  <van-dialog id="van-dialog" show="{{ show2 }}" />
  <view style="padding-bottom: 20%;"></view>
</view>
```

## 修改 showProfessor.wxss

添加搜索框和加载提示的样式：

```css
/* 固定搜索框容器 */
.search-container {
  position: sticky;
  top: 0;
  z-index: 999;
  background-color: #fff;
}

/* 搜索结果提示 */
.search-tip {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 20rpx 30rpx;
  background-color: #f7f8fa;
  font-size: 28rpx;
  color: #666;
}

.close-search {
  font-size: 32rpx;
  color: #999;
}

/* 加载中容器 */
.loading-container {
  display: flex;
  justify-content: center;
  align-items: center;
  padding: 30rpx;
}

/* 没有更多数据提示 */
.no-more {
  text-align: center;
  padding: 30rpx;
  color: #999;
  font-size: 28rpx;
}

/* 搜索无结果提示 */
.no-result {
  padding: 100rpx 0;
}

/* 搜索模式下禁用tab的样式（可选） */
.van-tab--disabled {
  opacity: 0.5;
  pointer-events: none;
}
```

## 使用说明

### 基础功能
1. **初始加载**：页面加载时加载第一个方向的前10条导师数据（可通过 `pageSize` 调整）
2. **切换方向**：切换 tab 时会重新加载当前方向的导师列表
3. **下拉刷新**：下拉刷新会重置页码并重新加载第一页数据
4. **上拉加载**：滚动到底部自动加载下一页数据
5. **加载状态**：显示加载中和没有更多数据的提示

### 搜索功能（新增）
1. **固定搜索框**：搜索框固定在页面顶部，下滑时始终可见
2. **搜索触发**：
   - 输入关键词后点击搜索图标或键盘搜索键
   - 支持搜索导师姓名、研究方向、职称、联系方式
3. **搜索结果**：
   - 显示匹配的导师总数
   - 自动跳转到第一个匹配导师所在的方向tab
   - 在搜索模式下，所有匹配的导师会显示在对应的方向tab下
4. **退出搜索**：点击"取消"按钮退出搜索模式，恢复到第一个方向
5. **搜索模式限制**：在搜索模式下，禁止手动切换tab（保证搜索结果的一致性）

### 后端接口参数
- `page`: 页码（默认1）
- `page_size`: 每页数量（默认10）
- `department_id`: 方向ID（可选，用于按方向筛选）
- `search`: 搜索关键词（可选，模糊匹配导师姓名、研究方向、职称、联系方式）

## 问题修复说明

**问题**：初始进入页面时不显示导师，需要切换方向才显示。

**原因**：
1. 初始加载时没有设置 `selectedDepartmentId`
2. 前端 wxml 通过 `ditem.id === pitem.department` 来过滤显示导师
3. 如果不设置初始方向ID，可能导致加载的导师与显示的tab不匹配

**解决方案**：
- 在 `onLoad` 成功回调中，设置 `selectedDepartmentId` 为第一个方向的 ID
- 这样初始加载的导师列表就会与第一个 tab 的方向匹配

## 优化效果

- ✅ 首屏加载时间大幅减少（只加载10条数据）
- ✅ 按需加载，节省流量
- ✅ 支持按方向筛选导师
- ✅ 良好的用户体验（加载提示、无更多数据提示）
- ✅ 防止重复加载
- ✅ **固定搜索框**：下滑时始终可见，方便随时搜索
- ✅ **智能搜索**：支持多字段模糊匹配
- ✅ **自动跳转**：搜索后自动定位到匹配导师所在的方向
- ✅ **搜索结果统计**：实时显示匹配的导师数量
- ✅ **一键退出**：轻松退出搜索模式，恢复正常浏览

## Bug 修复说明

### 问题：滚动加载时导师列表消失

**现象**：
- 在查看某个方向的导师时，往下滑动加载更多
- 导师列表突然全部消失
- 下拉刷新也不恢复
- 只能切换到其他方向才能恢复

**根本原因**：
- 在滚动加载更多时，如果 `selectedDepartmentId` 状态丢失或为空
- 后端请求没有携带 `department_id` 参数
- 可能返回其他方向的导师或空数据
- 前端通过 `ditem.id === pitem.department` 过滤时，导致当前tab下没有匹配的导师

**修复方案**：
1. **增强状态获取逻辑**：在 `loadProfessors` 方法中，如果 `selectedDepartmentId` 为空，从当前 active 的 tab 中获取 department_id
2. **状态同步**：如果发现 `selectedDepartmentId` 为空，自动同步更新
3. **防御性检查**：在 `onChange` 中添加数据有效性检查
4. **调试日志**：在关键位置添加 console.log，方便排查问题

**关键代码改动**：
```javascript
// 优先使用 selectedDepartmentId，如果为空则从当前 active 的 tab 获取
const departmentId = this.data.selectedDepartmentId || 
  (this.data.departmentList && this.data.departmentList.length > 0 && this.data.active >= 0
    ? this.data.departmentList[this.data.active].id 
    : null);
```

**如何验证修复**：
1. 打开微信开发者工具的控制台
2. 查看每次加载时的日志输出
3. 确认 `department_id` 参数始终正确传递
4. 在多个方向切换并滚动加载，验证不再出现列表消失问题
