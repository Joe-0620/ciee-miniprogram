# 前端分页加载实现方案

## 修改 showProfessor.js

```javascript
// pages/showProfessor/showProfessor.js
import Dialog from '@vant/weapp/dialog/dialog';
const config = require('../../utils/config.js');
Page({
  /**
   * 页面的初始数据
   */
  data: {
    dialogShow: false,
    usertype: '',
    isTriggered: false,
    refreshText: '下拉刷新',
    activeKey: 0,
    active: 0,
    departmentList: '',
    professorList: '',
    selectedTeacherId:'',//当前查看的老师id
    professorId: [],
    show: false,
    show1: false,//展示弹框
    show2:false,
    selectedValue: [],
    isPopupOpen: true,
    checked:true,
    open_time: '',
    close_time: '',
    // 新增分页相关字段
    currentPage: 1,
    pageSize: 10,
    hasNextPage: false,
    isLoadingMore: false,
    selectedDepartmentId: null, // 当前选中的方向ID
  },

  // ... getMessage 等其他方法保持不变 ...

  // 修改 onChange 方法，在切换方向时重新加载数据
  onChange(event) {
    const departmentIndex = event.detail.name;
    const department = this.data.departmentList[departmentIndex];
    
    wx.showToast({
      title: `正在查看 ${event.detail.title}`,
      icon: 'none',
    });

    // 切换方向时重置数据并加载新方向的导师
    this.setData({
      active: departmentIndex,
      selectedDepartmentId: department.id,
      currentPage: 1,
      professorList: []
    }, () => {
      this.loadProfessors();
    });
  },

  // 修改 onLoad，初始加载时只加载第一页数据
  onLoad(options) {
    const usertype = wx.getStorageSync('usertype');
    this.setData({
      usertype: usertype,
    });
    this.getSelectTime();

    var that = this;
    // 先加载方向列表
    wx.request({
      url: `${config.BASE_URL}/Professor_Student_Manage/professors_and_departments/`,
      method: "GET",
      data: {
        page: 1,
        page_size: that.data.pageSize
      },
      success: function(res) {
        that.setData({
          departmentList: res.data['departments'],
          professorList: res.data['professors'],
          hasNextPage: res.data['has_next'],
          currentPage: res.data['current_page']
        });
      },
      fail: function(err) {
        console.error('获取导师信息失败：', err);
      }
    });
  },

  // 新增：加载导师列表的方法
  loadProfessors(isLoadMore = false) {
    const that = this;
    
    if (this.data.isLoadingMore) {
      return; // 避免重复加载
    }

    this.setData({
      isLoadingMore: true
    });

    const params = {
      page: this.data.currentPage,
      page_size: this.data.pageSize
    };

    // 如果选中了特定方向，添加方向过滤
    if (this.data.selectedDepartmentId) {
      params.department_id = this.data.selectedDepartmentId;
    }

    wx.request({
      url: `${config.BASE_URL}/Professor_Student_Manage/professors_and_departments/`,
      method: "GET",
      data: params,
      success: function(res) {
        const newProfessors = res.data['professors'];
        const updatedList = isLoadMore 
          ? that.data.professorList.concat(newProfessors)
          : newProfessors;

        that.setData({
          professorList: updatedList,
          hasNextPage: res.data['has_next'],
          currentPage: res.data['current_page'],
          isLoadingMore: false
        });

        // 如果是首次加载，也加载方向列表
        if (!isLoadMore && res.data['departments']) {
          that.setData({
            departmentList: res.data['departments']
          });
        }
      },
      fail: function(err) {
        console.error('获取导师信息失败：', err);
        that.setData({
          isLoadingMore: false
        });
        wx.showToast({
          title: '加载失败，请重试',
          icon: 'none'
        });
      }
    });
  },

  // 新增：上拉加载更多
  loadMoreProfessors() {
    if (!this.data.hasNextPage || this.data.isLoadingMore) {
      return;
    }

    this.setData({
      currentPage: this.data.currentPage + 1
    }, () => {
      this.loadProfessors(true);
    });
  },

  // 修改下拉刷新方法
  onPullDownRefresh() {
    this.setData({
      isTriggered: true,
      refreshText: "刷新导师信息中...",
      currentPage: 1
    });
    
    this.loadProfessors(false);
    
    setTimeout(() => {
      this.setData({
        isTriggered: false,
        refreshText: "下拉刷新"
      });
    }, 1000);
  },

  // ... 其他方法保持不变 ...

  /**
   * 页面上拉触底事件的处理函数
   */
  onReachBottom() {
    this.loadMoreProfessors();
  },
});
```

## 修改 showProfessor.wxml

在滚动容器中添加触底加载提示：

```xml
<!--pages/showProfessor/showProfessor.wxml-->
<page-meta page-style="{{ (show || show1) ? 'overflow: hidden;' : '' }}" />
<view class="mask" wx:if="{{isPopupOpen}}"></view>
<view class="con">
  <van-notice-bar
      scrollable
      text="互选开放时间: {{ open_time }}，互选关闭时间: {{ close_time }}"
    />
  <view class="scroll">
    <view wx:if="{{isTriggered}}" class="refresh-text-container">
      <!-- 下拉刷新的视图内容 -->
      <text class="refresh-text">{{refreshText}}</text>
    </view>
    <scroll-view 
      class="center" 
      scroll-y="true" 
      refresher-enabled="{{!disablePullDownRefresh}}"
      bindrefresherrefresh="onPullDownRefresh"
      refresher-triggered="{{isTriggered}}"
      bindscrolltolower="loadMoreProfessors"
      lower-threshold="100"
    >
      <van-tabs
        swipeable 
        animated 
        sticky 
        ellipsis="{{false}}"
        active="{{ active }}" 
        bind:change="onChange" 
      >
        <block wx:for="{{departmentList}}" wx:key="id" wx:for-item="ditem">
          <van-tab title="{{ditem.department_name}}">
            <view wx:for="{{professorList}}" wx:key="id" wx:for-item="pitem">
              <block wx:if="{{ditem.id === pitem.department}}">
                <!-- 导师卡片内容保持不变 -->
                <view class="van-card-container">
                  <van-card>
                    <!-- ... 保持原有内容不变 ... -->
                  </van-card>
                </view>
              </block>
            </view>
            
            <!-- 加载提示 -->
            <view class="loading-container" wx:if="{{isLoadingMore}}">
              <van-loading type="spinner" size="24px">加载中...</van-loading>
            </view>
            
            <!-- 没有更多数据提示 -->
            <view class="no-more" wx:if="{{!hasNextPage && professorList.length > 0}}">
              <text>没有更多导师了</text>
            </view>
          </van-tab>
        </block>
      </van-tabs>
    </scroll-view>
  </view>
  
  <!-- 弹框等其他内容保持不变 -->
  <van-popup 
    show="{{ show }}" 
    bind:close="onClose" 
    position="bottom" 
    round
    custom-style="height: 65%" 
    closeable 
    close-icon-position="top-left"
    safe-area-tab-bar="{{true}}"
  >
    <!-- ... 保持原有内容不变 ... -->
  </van-popup>
  
  <van-dialog id="van-dialog" show="{{ show2 }}" />
  <view style="padding-bottom: 20%;"></view>
</view>
```

## 修改 showProfessor.wxss

添加加载提示的样式：

```css
/* 加载中容器 */
.loading-container {
  display: flex;
  justify-content: center;
  align-items: center;
  padding: 30rpx;
}

/* 没有更多数据提示 */
.no-more {
  text-align: center;
  padding: 30rpx;
  color: #999;
  font-size: 28rpx;
}
```

## 使用说明

1. **初始加载**：页面加载时只加载前10条导师数据（可通过 `pageSize` 调整）
2. **切换方向**：切换 tab 时会重新加载当前方向的导师列表
3. **下拉刷新**：下拉刷新会重置页码并重新加载第一页数据
4. **上拉加载**：滚动到底部自动加载下一页数据
5. **加载状态**：显示加载中和没有更多数据的提示

## 优化效果

- ✅ 首屏加载时间大幅减少（只加载10条数据）
- ✅ 按需加载，节省流量
- ✅ 支持按方向筛选导师
- ✅ 良好的用户体验（加载提示、无更多数据提示）
- ✅ 防止重复加载
