# 名额管理和候补自动同步功能说明

## 📋 功能概述

本系统实现了完整的招生名额管理和候补状态自动同步机制，确保数据一致性和准确性。

## 🎯 核心功能

### 1. 专业总招生名额管理

**位置：** Django Admin → 招生管理 → 专业

**功能：**
- 手动设置每个专业的总招生人数 (`total_admission_quota`)
- 该数值用于判断学生是否为候补

**示例：**
```
计算机科学与技术: 总招生名额 = 30人
- 排名 ≤ 30: 正式录取
- 排名 > 30: 候补 (候补顺序 = 排名 - 30)
```

---

### 2. 批量导入学生信息

**功能：** 根据专业总招生名额自动计算候补状态

**导入逻辑：**
```python
if 学生综合排名 <= 专业总招生名额:
    is_alternate = False  # 正式录取
    alternate_rank = None
else:
    is_alternate = True   # 候补
    alternate_rank = 排名 - 总招生名额
```

**示例CSV格式：**
```csv
专业代码,专业,考生编号,姓名,综合成绩,综合排名,研究生类型,学生类型,手机号,身份证号
081200,计算机科学与技术,100194202312345,张三,81.6,28,2,2,13800138000,110101199001011234
081200,计算机科学与技术,100194202312346,李四,80.2,32,2,2,13900139000,110101199001011235
```

**结果：**
- 张三：排名28 ≤ 30 → 正式录取
- 李四：排名32 > 30 → 候补（候补顺序2）

---

### 3. 批量导入导师招生名额（新增功能）

**位置：** Django Admin → 导师管理 → 一键导入导师硕士名额

#### 3.1 智能验证机制

导入时系统会自动：

1. **统计各专业导师名额总和**
   ```
   计算机科学与技术:
   - 导师A: 北京3人 + 烟台0人 = 3人
   - 导师B: 北京2人 + 烟台0人 = 2人
   - 导师C: 北京4人 + 烟台0人 = 4人
   总计: 9人
   ```

2. **对比专业总招生名额**
   ```
   专业总招生名额: 30人
   导师名额总和: 35人
   超额: 5人 ⚠️
   ```

3. **弹出确认页面**
   - 显示超额信息表格
   - 提供两个选项：
     - ✅ **自动同步专业总招生名额** (推荐)
     - ⚠️ **仍然导入（不调整）**

#### 3.2 选项说明

**选项1：自动同步专业总招生名额**
```
1. 将专业总招生名额调整为导师名额总和 (30 → 35)
2. 自动调整候补学生状态
   - 排名31-35的学生: 候补 → 正式录取
3. 导入导师名额数据
```

**选项2：仍然导入（不调整）**
```
1. 保持专业总招生名额不变 (仍为30)
2. 导入导师名额数据
3. 可能导致实际可录取人数少于导师名额总和
```

---

### 4. 修改专业总招生名额（新增功能）

**位置：** Django Admin → 招生管理 → 专业 → 编辑专业

#### 4.1 增加名额

**场景：** 总招生名额从 30 → 35

**自动处理：**
```python
1. 验证通过（可以增加）
2. 保存新名额 (35)
3. 自动调整候补状态:
   - 找到排名31-35的学生
   - 将他们从候补转为正式录取
   - 更新 is_alternate 和 alternate_rank 字段
4. 显示成功消息: "已自动调整 5 名学生的候补状态"
```

#### 4.2 减少名额

**场景：** 总招生名额从 30 → 25

**验证逻辑：**
```python
1. 检查导师名额总和
   - 如果导师名额总和 = 28人
   - 新名额25 < 28 ❌
   - 抛出错误: "专业的总招生名额不能少于已分配的导师名额总和(28人)"

2. 如果验证通过 (如导师名额总和 = 20人)
   - 保存新名额 (25)
   - 自动调整候补状态:
     - 排名26-30的学生: 正式录取 → 候补
     - 排名31+的学生: 候补顺序重新计算
   - 显示成功消息
```

---

## 🔄 完整工作流程

### 流程1：初始设置

```
1. 在"专业管理"中设置每个专业的总招生名额
   ↓
2. 批量导入学生信息
   ↓
3. 系统自动计算并标记候补学生
```

### 流程2：导入导师名额（无超额）

```
1. 准备导师名额CSV文件
   ↓
2. 上传并导入
   ↓
3. 系统验证: 各专业导师名额 ≤ 专业总名额 ✅
   ↓
4. 直接导入成功
```

### 流程3：导入导师名额（有超额）

```
1. 上传CSV文件
   ↓
2. 系统检测: 某些专业超额 ⚠️
   ↓
3. 弹出确认页面，显示超额详情
   ↓
4a. 选择"自动同步" → 更新专业总名额 → 调整候补状态
4b. 选择"仍然导入" → 仅导入导师名额
   ↓
5. 导入完成
```

### 流程4：后期调整专业名额

```
1. 进入"专业管理"编辑专业
   ↓
2. 修改总招生名额
   ↓
3a. 增加名额:
    - 自动将部分候补学生转为正式
    - 显示调整结果
3b. 减少名额:
    - 验证不能少于导师名额总和
    - 如果通过，自动将部分学生转为候补
   ↓
4. 保存成功
```

---

## ⚠️ 重要限制和验证

### 1. 减少专业总名额的限制

```python
新的总招生名额 >= 该专业所有导师名额之和
```

**示例：**
```
专业: 计算机科学与技术
导师名额总和: 28人

✅ 可以设置为: 30人, 28人
❌ 不能设置为: 25人 (会报错)
```

### 2. 候补状态同步规则

- **自动同步时机：**
  1. 批量导入学生时
  2. 修改专业总招生名额时
  3. 导入导师名额并选择"自动同步"时

- **同步逻辑：**
  ```python
  for student in 该专业所有学生:
      if student.final_rank <= total_admission_quota:
          is_alternate = False
          alternate_rank = None
      else:
          is_alternate = True
          alternate_rank = final_rank - total_admission_quota
  ```

---

## 📊 数据示例

### 示例场景

**专业：** 计算机科学与技术  
**初始总招生名额：** 30人

#### 步骤1：导入学生

| 姓名 | 排名 | 初始状态 | 候补顺序 |
|------|------|---------|---------|
| 张三 | 28 | 正式 | - |
| 李四 | 29 | 正式 | - |
| 王五 | 30 | 正式 | - |
| 赵六 | 31 | 候补 | 1 |
| 钱七 | 32 | 候补 | 2 |

#### 步骤2：导入导师名额

导师名额总和 = 35人 > 30人 ⚠️

**选择"自动同步"后：**

| 姓名 | 排名 | 新状态 | 候补顺序 |
|------|------|--------|---------|
| 张三 | 28 | 正式 | - |
| 李四 | 29 | 正式 | - |
| 王五 | 30 | 正式 | - |
| 赵六 | 31 | 正式 (变化) | - |
| 钱七 | 32 | 正式 (变化) | - |

专业总名额: 30 → 35

---

## 🛠️ 技术实现

### 1. 信号处理 (Enrollment_Manage/models.py)

```python
@receiver(pre_save, sender=Subject)
def validate_and_sync_admission_quota(sender, instance, **kwargs):
    # 验证减少名额的合法性
    # 防止名额少于已分配的导师名额总和
```

### 2. 候补同步函数

```python
def sync_student_alternate_status(subject):
    # 根据专业总名额和学生排名
    # 自动调整所有学生的候补状态
    # 返回更新的学生数量
```

### 3. 导入验证逻辑

```python
def _validate_quota_import(self, import_data):
    # 统计各专业的导师名额总和
    # 对比专业总招生名额
    # 返回超额警告列表
```

---

## ✅ 使用建议

1. **首次设置：**
   - 先在"专业管理"中设置合理的总招生名额
   - 然后批量导入学生
   - 最后导入导师名额

2. **导入导师名额时：**
   - 如果出现超额提示，优先选择"自动同步"
   - 这样可以确保数据一致性

3. **后期调整：**
   - 修改专业总名额前，先查看该专业的导师名额总和
   - 确保新名额 ≥ 导师名额总和

4. **数据检查：**
   - 定期检查学生的候补状态是否正确
   - 系统会自动同步，但建议验证关键数据

---

## 📝 更新日志

**版本：** 2.0  
**更新日期：** 2026-01-25

**新增功能：**
1. ✅ 导师名额导入时的智能验证和确认机制
2. ✅ 专业总名额变更时自动同步候补状态
3. ✅ 减少名额时的安全验证
4. ✅ 详细的超额提示和处理选项

**修改文件：**
- `Enrollment_Manage/models.py` - 添加信号和同步函数
- `Enrollment_Manage/admin.py` - 专业保存时同步候补
- `Professor_Student_Manage/admin.py` - 导入逻辑优化
- `wxcloudrun/templates/admin/import_quota_confirm.html` - 新增确认页面

---

## 🔗 相关文件

- 模型定义: `Enrollment_Manage/models.py`
- Admin配置: `Enrollment_Manage/admin.py`
- 导师导入: `Professor_Student_Manage/admin.py`
- 确认模板: `wxcloudrun/templates/admin/import_quota_confirm.html`
